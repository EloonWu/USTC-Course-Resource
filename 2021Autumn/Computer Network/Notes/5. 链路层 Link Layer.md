# 5. 链路层 The link Layer

## 5.1 链路层概述

* 一些术语
  * 结点：将运行链路层协议的任何设备称为结点
  * 链路：将沿着通信路径连接相邻结点的通信信道称为链路

### 5.1.1 链路层提供的服务

尽管任一链路层的基本服务都是将数据报通过单一通信链路从一个结点移动到相邻结点，但是所提供的服务细节能够随着链路层协议的不同而变化

* 成帧：在网络层数据报经链路层传输之前，所有的链路层协议都会将其用链路层帧封装起来。一个帧由一个数据字段和若干首部字段组成。
* 链路接入：**媒体访问控制MAC**协议规定了帧在链路上传输的规则。
* 可靠交付（部分协议提供）：保证无差错经链路层移动每个网络层数据报。链路层的可靠交付通常是通过确认重传取得的。
* 差错检测和纠正：接收方不仅能检测帧中出现的比特差错，还可以准确地确定帧中的差错出现的位置。
* 流量控制：调节发送速度，避免接收结点缓存溢出。提供可靠交付的链路层协议，不需要专门的流量控制；不提供可靠交付发链路层协议，需要流量控制机制。

### 5.1.2 链路层在哪儿实现

* 路由器：链路层在**线卡**中实现
* 主机：链路层主题部分在**网络适配器（网卡）**中实现

线卡/网络适配器连接物理媒体，还实现物理层的功能

链路层由硬件和软件实现：

* 网卡中的控制器芯片：组帧、链路接入、检错、可靠交付、流量控制等
* 主机的链路层软件：与网络层接口，激活控制器硬件、响应控制器中断等

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-24 143653.png)



## 5.2 差错检验和纠正技术

* 传输出错的类型
  * 单个错：由随机的信道热噪声引起，一次只影响1位
  * 突发错：由瞬间的脉冲噪声引起，一次影响许多位，使用突发长度表示突发错影响的最大数据位数
* 差错控制编码的类型
  * 检错码：只能检测出传输错误的编码，不能确定出错位置，通常与反馈重传机制结合进行差错恢复
  * 纠错码：能够确定错误位置并自行纠正的编码

### 5.2.1 奇偶校验

假设要发送的数据包含d个比特。在偶校验方案中，发送方只需包含一个附加的比特，选择它的值，使得这 d+1个比特中1的总数是偶数。对于奇校验方案，选择校验比特值使得有奇数个1.

* 单比特奇偶校验：可检测奇数个比特错误，检错率为50%，编码集的海明距离是2
* 二维奇偶校验：可检测2比特错和纠正单比特错，编码集海明距离为3，有利于检测突发错误。

### 5.2.2 检验和方法

为什么运输层使用检验和而链路层使用CRC呢？

运输层通常是在主机中作为用户操作系统的一部分用软件实现的。因为运输层差错检测侧用软件实现，采用简单而快速如检验和这样的差错检验方案是重要的。在另一方面，链路层的差错检测在适配器中用专用的硬件实现，能够快速执行更复杂的CRC操作。

### 5.2.3 循环冗余检测

考虑d比特的数据D，发送结点要将它发送给接收结点。发送方和接收方首先必须协商一个r+1比特模式，称为**生成多项式**。将其表示为G。要求G的最高有效位（最左边）的比特为1。CRC编码的关键思想是，对于一个给定的数据段D，发送方要选择r个**附加比特R**，并将它们附加到D上，使得得到的d+r比特模式用模2算术恰好能被G整除。用CRC进行差错检测的过程是，接收方用G去除接收到的d+r比特。如果余数为非零，接收方就知道出现了差错；否则认为数据正确而被接收。

CRC计算采用模2算术来做，在加法中不进位，在减法中不借位，乘法与除法与在二进制算术中是相同的。用G来除$D·2^r$，余数的值即为R



## 5.3 多路访问链路和协议

* 链路的两种类型
  * 点到点链路：仅连接了一个发送方和一个接收方的链路
  * 广播链路：连接了许多节点的单一共享链路，任何一个结点发送的数据可被链路上的其他结点接收到

任何多路访问MAC协议可以划分为三种类型之一：**信道划分协议、随机接入协议和轮流协议。**

* 信道划分：**将信道划分为若干子信道**，每个结点固定分配一个子信道，不会发生冲突
  * 关注公平性，轻负载时信道利用率不高
* 随机接入：**不划分信道**，每个结点自行决定何时发送，发生冲突后设法解决
  * 轻负载时信道利用率高，重负载时冲突严重
* 轮流使用信道：**不划分信道**，有数据的结点轮流发送，不会出现冲突
  * 信道利用率高，公平性好，但是需要引入额外机制

###  5.3.1 信道划分协议

* TDMA：时分多址
  * 将信道的使用时间划分成帧，每个结点在帧中被分配一个固定长度的时间片，每个时间片可以发送一个分组
  * 结点只能在分配给自己的时间片内发送；若结点不发送，其时间片轮空

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-24 161424.png)

* FDMA：频分多址
  * 将信道频谱划分为若干子频带，每个结点被分配一个固定的子频带；若结点不发送，则频带空闲

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-24 161605.png)

* CDMA：码分多址
  * 对每一个结点分配一种不同的编码。每一个结点用它唯一的编码来对它发送的数据进行编码。不同的结点能够同时传输，并且各自相应的接收方仍能正确接收发送方编码的数据比特，而不在乎其他结点的干扰传输。
  * CDMA允许所有结点同时使用整个信道

### 5.3.2 随机接入协议

随机接入的基本思想：

* 当结点由数据要发送时，以信道速率R发送，发送前不需要协调
* 随机接入MAC协议规定如何检测冲突，以及如何从冲突中恢复

随机接入MAC协议的例子：

* 发送前不监听信道：ALOHA家族
* 发送前监听信道：CSMA家族

#### 5.3.2.1 时隙ALOHA

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 205759.png)

* 操作
  * 结点从上层收到数据后，在下一个时隙发送
  * 若时隙结束前未检测到冲突，结点可在下一个时隙发送新的帧
  * 若检测到冲突，结点在随后的每一个时隙中以概率P重传，知道发送成功
* 优点
  * 单个活跃结点可以以信道速率连续发送
  * 分散式：结点自行决定什么时候发送
  * 简单
* 缺点
  * 发生冲突时的时隙被浪费了
  * 由于概率重传，有些时隙被闲置
  * 需要时钟同步
* 时隙ALOHA的效率

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-24 194233.png)

#### 5.3.2.2 ALOHA

* 基本思想
  * 不需要时钟同步，任何结点有数据发送就可以立即发送
  * 结点通过监听信道判断本次传输是否成功
  * 若不成功，立即以概率P重传，以概率(1-P)等待一个帧时长后再做决定
* ALOHA的效率

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-24 195835.png)

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-24 195708.png)

#### 5.3.2.3 CSMA 载波侦听多路访问

* 基本思想
  * 发送前监听信道
    * 信道空闲：发送整个帧
    * 信道忙：推迟发送
* 冲突仍有可能发生
  * 由于存在传输延迟，结点可能没有监听到其他结点正在发送
  * 即使忽略传输延迟，当两个（或多个）结点同时发现信道由忙变空闲，并都决定立即发送时，仍然会发生冲突

#### 5.3.2.4 CSMA/CD 具有碰撞检测的载波侦听多路访问

* 基本思想
  * 在发送的过程中检测冲突
  * 检测到冲突后，立即停止发送剩余部分
  * 立即启动冲突解决的过程
* 以太网的MAC协议
  * 网卡从网络层接收数据报，构造以太帧
  * 若网卡检测到信道空闲，立即发送帧；若信道忙，坚持监听直至发现信道空闲，然后发送帧
  * 若网卡发送完整个帧而没有检测到冲突，认为发送成功
  * 若网卡在传输过程中检测到冲突，立即挺迟发送帧，并发送一个阻塞信号（加强冲突）
  * 网卡进入**指数回退**阶段，选择一个等待时间：
    * 第一次冲突后: 从{0,1}中选择K，延迟K· 512比特时间
    * 第二次冲突后: 从{0,1,2,3}中选择K，……
    * 第三次冲突后: 从{0,1,2,3,4,5,6,7}中选择K，……
    * .....
    * 第10次冲突后，从{0,1,2,3,4,…,1023}中选择K，……
  * 返回第二步

#### 5.3.2.5 CSMA/CD效率

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-24 201210.png)

### 5.3.3 轮流协议

* 轮询
  * 主节点轮流“邀请”从节点发送，被邀请到的从节点允许发送
  * 缺点
    * 引入轮询延迟
    * 单点失效风险（主节点）

* 令牌传递
  * 网络中有一个令牌，按照预定顺序在节点间传递
  * 获得的令牌的结点可以发送
  * 发送完数据后释放令牌
  * 缺点
    * 令牌传递延迟
    * 单点失效风险（令牌）

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 212433.png)



## 5.4 局域交换网

* 局域网LAN
  * 将小范围内的计算机以及外设连接起来的网路，范围在几公里以内，通常为个人或机构所有
* 城域网MAN
  * 通常覆盖一个城市范围，要能支持数据、音频和视频在内的综合业务，服务质量好，支持的用户数量多
* 广域网WAN
  * 通常覆盖一个国家或一个洲，规模和容量可以任意扩大

### 5.4.1 链路层寻址和ARP

#### 5.4.1.1 MAC地址

* 链路层编址
  * 每一块网卡固定分配一个地址，称为物理地址、硬件地址、链路层地址、MAC地址等
  * MAC地址长6个字节，一般用由“：”或“-“分隔的6个十六进制数表示
  * MAC地址由IEEE负责分配，每块适配器的地址是全球唯一的：
    * 网卡生产商向IEEE购买一块MAC地址空间（前3字节）
    * 生产商确保生产的每一块网卡有不同的MAC地址
    * MAC地址固化在网卡的ROM中

* 帧的目的地址的类型
  * 单播地址：网卡的MAC地址，地址最高比特为0
  * 多播地址：标识一个多播组的逻辑地址，地址最高比特为1
  * 广播地址：ff:ff:ff:ff:ff:ff
* 网络适配器仅将发送给本节点的帧交给主机
* 若将适配器设置成混收模式，适配器将收到的所有帧交给主机

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 215211.png" style="zoom: 67%;" />

* 当发送节点A、接收节点B位于同一个物理网络上时，数据报可从A直接交付给B：
  * A的网络层将数据报、B的MAC地址交给数据链路层
  * A的数据链路层将数据报封装在一个链路层帧中，帧的目的地址=B的MAC地址
  * B的适配器收到帧，根据目的MAC地址判断是发给本机的，取出数据报交给网络层

#### 5.4.1.2 地址解析协议

已知IP地址，如何得到对应的MAC地址

* 静态映射IP地址-MAC地址的缺点

  * 主机每次使用的IP地址可能不同
  * 主机可能更换网卡

* **地址解析协议（ARP）**用于动态获得IP地址-MAC地址映射，其基本思想是：

  * 若节点A希望获得节点B的MAC地址，节点A广播B的IP地址（地址解析请求）
  * 节点B用自己的MAC地址进行响应

* ARP报文格式

  ![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 215953.png)

  * 硬件类型：硬件接口类型。对于以太网，该值为“1”
  * 协议类型：高层协议地址类型。对于IP地址，该值为$0800_{16}$
  * 操作：ARP请求为1，ARP响应为2
  * 在以太网上，ARP报文封装在以太帧中传输

* **地址解析的过程**

  A想知道B的MAC地址：

  * A构造一个ARP请求，在发送方字段填入自己的MAC地址和IP地址，在目标字段填入B的IP地址
  * A将ARP请求封装在广播帧中发送
  * 每个收到ARP请求的节点用目标IP地址与自己的IP地址比较，地址相符的节点进行响应（B响应）
  * B构造一个ARP响应，交换发送方与目标字段内容，在发送方硬件地址字段填入自己的MAC地址，修改操作字段为2
  * B将ARP响应封装在单播帧（目的地址为A的MAC地址）中发送

  ![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 220722.png)

* ARP改进

  * ARP缓存
    * 每个节点在内存中维护一个地址映射（绑定）表，称ARP缓存。每次发送数据报前先查询ARP缓存，若找不到则发送ARP请求，并在收到ARP响应后将地址映射缓存起来
    * ARP缓存中的信息，在超时（一般为15～20分钟）后删除
  * 主动学习
    * 从ARP请求中获取地址绑定信息：每个节点可以收到全部的ARP请求报文，可将发送节点的地址映射缓存到自己的ARP表中

#### 5.4.1.3 发送数据报到子网外



### 5.4.2 以太网

* 总线拓扑：共享式以太网

  * 总线
    * 以同轴电缆作为共享传输媒体（总线）
    * 所有节点通过特殊接口连接到这条总线上

  ![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 222216.png)

  * 集线器
    * 一个物理层中继器，从一个端口进入的物理信号（光，电），放大后立即从其它端口输出
    * 集线器相当于共享电缆

  ![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 222236.png)

* 星型拓扑：交换式以太网
  * 交换机
    * 主机通过双绞线或光纤连接到交换机
    * 交换机在端口之间存储转发帧（链路层设备）
    * 主机与交换机之间为全双工链路

#### 5.4.2.1 以太网帧的结构

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 222444.png)

* 以太网帧的结构
  * Preamble（前导码）
    * 7个10101010字节，后跟一个10101011字节，用于在发送方和接收方之间建立时钟同步
    * 一般不计入以太帧的长度
  * Dest.Address/Src Address：目的/源MAC地址
  * Type（2字节）: 指出Data所属的高层协议（如IP、ARP等），每个协议有一个编号
  * Data：46～1500字节，不足46字节填充至46字节
  * CRC（4字节）: 对dest addr.、src addr.、type和data四个字段计算得到的CRC码

* 以太网技术向网络层提供不可靠、无连接的服务
  * 不可靠
    * 接收方网卡不发送确认
    * 接收方网卡丢弃CRC错误的帧
    * 依靠上层协议（TCP或应用）进行错误恢复
  * 无连接
    * 发送方网卡与接收方网卡之间没有握手

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 222942.png" style="zoom:60%;" />

#### 5.4.2.3 以太网技术

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-25 223632.png" style="zoom:67%;" />

* 交换式以太网的最小帧长及规模
  * 交换式以太网不再使用CSMA/CD协议，理论上不再需要限制帧的最小长度。但为了向后兼容，帧格式及最小帧长度的限制仍然保持不变
  * 由于交换式以太网不再使用CSMA/CD协议，网络直径不再受到信号最大往返时间的限制
  * 交换式以太网的MAC层除了帧格式保持不变外，其它都和共享式以太网不同

### 5.4.3 链路层交换机

* 链路交换机功能
  * 存储-转发帧
  * 检查输入帧的MAC地址，有选择的将帧转发到一个或多个输出链路
* 链路交换机特点
  * 透明：主机感觉不到交换机的存在
  * 即插即用、自主学习：交换机不需要配置
* 交换机支持多对传输同时进行
  * 主机通过点-点线路连接到交换机
  * 交换机缓存分组，在每一条输入链路上执行以太网协议：
    * 每条链路是一个冲突域
    * 全双工通信
  * 多对端口间可以同时传输，不会有冲突发生

#### 5.4.3.1 交换机转发和过滤

* 每个交换机内部有一张端口转发表，每个表项记录以下信息:

  * MAC地址，到达该MAC地址的端口

  <img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-26 095126.png" style="zoom:67%;" />

* 用帧的目的地址查找转发表**（转发决策）**

  * 若目的地址所在端口 = 帧的进入端口，丢弃帧
  * 若目的地址所在端口 ≠ 帧的进入端口，转发帧
  * 若目的地址不在转发表中，扩散帧

#### 5.4.3.2 自学习

* 交换机自主学习“哪个主机通过哪个端口可达”
  * 当一个帧到达时，交换机从**源MAC地址了解到发送节点**，**从帧到来的端口**了解到发送节点的位置（从该端口可达）
  * 在转发表中记录发送节点和可达端口
* 用帧的源地址查找转发表**（更新转发表）**：
  * 若找到地址，将对应表项的**生存期设为最大值**
  * 若没有找到该地址，添加源地址和进入端口到转发表，设置表项的生存期为最大值

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-26 095704.png" style="zoom:60%;" />

#### 5.4.3.3 链路层交换机的性质



#### 5.4.3.4 交换机和路由器比较

* 交换机工作于链路层，根据MAC地址存储转发帧；

  路由器工作于网络层，根据IP地址存储转发数据报

* 交换机是即插即用设备

  路由器需要手工配置

* 交换机转发速度快，成本低（二层设备）

  路由器转发速度慢，成本高（三层设备）

* 交换机不能连接异构链路（即MAC协议不同的网络），因为交换机知识按原样转发帧

  路由器可以连接异构链路，因为路由器需要重新封装链路层帧

* 交换机需要运行生成树算法消除冗余链路，生成树算法假设网络是扁平的，对于网络中的结点总数是有限制的

  路由器无此限制

* 交换机不能阻断广播帧的传播

  * 交换机只能学习到单播MAC地址，所有广播帧都会扩散发送
  * 通过交换机连接的所有主机在同一个广播域中

  路由器可以阻断广播帧的传播

  * 路由器根据IP地址转发包（看不到MAC地址）
  * 每个路由器端口是一个独立的广播域

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-26 101220.png" style="zoom:60%;" />

### 5.4.4 虚拟局域网

* VLAN的基本概念
  * 虚拟局域网VLAN：
    * 位于物理局域网上的一个逻辑IP子网，包含了配置为该VLAN成员的所有结点
  * 每个VLAN在逻辑上是一个独立的网络
    * 每个VLAN是一个单独的广播域：一个VLAN中的所有帧流量被限制在该VLAN中
    * 不同VLAN之间的通信要依赖于网络层路由
  * 划分VLAN通过软件配置完成

* Port-based VLAN

  * 将交换机的某些端口强制性地分配给某个VLAN,使得一个物理交换机像多个虚拟交换机一样运行

  <img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-26 102344.png" style="zoom:80%;" />

* 使用VLAN配置网络
  * VLAN实现的基础是支持VLAN功能的交换机
  * 管理员配置VLAN
    * 管理员决定将物理网络划分成几个VLAN、每个VLAN的名字、每个机器在哪个VLAN上
    * 在每个交换机上建立一个配置表，指出通过哪个端口可以到达哪些VLAN的成员（一个交换机端口可以到达多个VLAN的成员）

* 如何划分VALN
  * 基于交换机端口划分
    * 将某些交换机端口直接、强制性的分配给某个VLAN
  * 基于MAC地址划分
    * 根据用户结点的MAC地址划分VLAN
  * 基于IP地址划分
    * 根据IP子网地址划分 VLAN

* 交换机如何在VLAN间转发帧
  * 当一个帧到达时
    * 交换机判断该帧属于哪个VLAN（帧所属的VLAN = 发送节点所属的VLAN）
      * 交换机根据帧的到达端口、源MAC地址或源IP地址（取决于VLAN的划分方法），查找VLAN配置表
      * 为避免重复查找 VLAN配置表，交换机将VLAN标识放入帧头中
      * 后续交换机通过检查帧头的VLAN标识，得知这个帧所属的VLAN
    * 查找配置表得到该VLAN对应的端口
    * 在该VLAN对应的所有端口上转发帧

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-26 103408.png" style="zoom:60%;" />

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-26 103538.png" style="zoom:60%;" />



## 5.5 链路虚拟化：网络作为链路层

### 5.5.1 多协议标签交换MPLS





## 5.6 数据中心网络

### 5.6.1 负载均衡

* 负载均衡器
  * 接收外部客户的请求
  * 在数据中心内部分配工作负载
  * 向外部客户返回结果（向客户隐藏数据中心内部细节）

### 5.6.2 交换机之间具有丰富的连接

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-26 111522.png" style="zoom:80%;" />



## 5.7 回顾：Web页面请求的历程

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-11-26 111803.png" style="zoom:60%;" />

### 5.7.1 准备：DHCP、UDP、IP和以太网

（1）操作系统生成一个DHCP请求报文，并将这个报文放入具有目的地端口67（DHCP服务器）和源端口68（DHCP客户）的UDP报文段中。该UDP报文段则被放置在一个具有广播IP目的地地址（255.255.255.255）和源IP地址0.0.0.0的IP数据报中

（2）包含DHCP请求报文的IP数据报备放置在以太网帧中。该以太网帧具有目的MAC地址FF:FF:FF:FF:FF:FF，使该帧将广播到与交换机连接的所有设备；该帧的源MAC地址是BOB主机的MAC地址

（3）包含DHCP请求的广播以太网帧是第一个由BOB主机发送到以太网交换机的帧。该交换机在所有的出端口广播入帧，包括连接到路由器的端口

（4）
