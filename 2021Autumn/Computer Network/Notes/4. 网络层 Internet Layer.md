# 4. 网络层 Internet Layer
## 4.1 概述
### 4.1.1 转发和路由选择

网络层重要的三个功能

* 转发	当一个分组到达路由器的一条输入链路时，路由器必须将该分组移动到适当的输出链路。转发是路由器本地的动作。
* 路由选择    当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。路由选择是指网络范围的过程。
* 连接建立

每台路由器具有一张转发表，路由器通过检查到达分组首部字段的值来转发分组，然后使用该值在该路由器的转发表中索引查询。路由选择算法决定了插入路由器的转发表中的值。路由选择算法可能是集中式的或是分布式的

链路层交换机：基于链路层字段中的值做转发决定
路由器：基于网络层字段中的值做转发决定

### 4.1.2 网络服务模型

当运输层向网络层传递一个分组时，能由网络层提供的特定服务包括

* 确保交付	确保分组最终到达目的地
* 具有时延上界的确保交付
* 有序分组交付
* 确保最小宽带    只要发送主机以低于特定比特率的速率传输比特，则分组不会丢失，且每个分组会在预定的时延内到达
* 确保最大时延抖动    确保在目的地接收到两个分组的时间差等于在发送时的时间差（或间隔变化不超过某一个特定的值）
* 安全性服务、

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-15 234821.png)

计算机网络体系结构

* 因特网

* 恒定比特率(CBR)ATM网络服务
* 可用比特率(ABR)ATM网络服务



## 4.2 虚电路网络和数据报网络

网络层也能在两台主机之间提供无连接服务或连接服务

* 在网络层中，这些服务是由**网络层向运输层提供的主机到主机的服务**；在运输层中，这些服务是运输层向应用层提供的进程到进程的服务
* 仅在网络层提供连接服务的计算机网络称为**虚电路网络**；仅在网络层提供无连接服务的计算机网络称为**数据报网络**

### 4.2.1 虚电路网络
一条虚电路的组成：

* 源和目的主机之间的**路径**（即一系列链路和路由器）
* **VC号**，沿着该路径的每段链路的一个号码
* 沿着该路径的每台路由器中的**转发表表项**

属于一条虚电路的分组将在它的首部携带一个VC号。因为一条虚电路在每条链路上可能具有不同的VC号，每台中间路由器必须用一个新的VC号替代每个传输分组的VC号。

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-16 000339.png)

在虚电路网络中，网络的路由器必须为进行中的链接维持**链接状态信息**，每当跨越一台路由器创建一个新连接，必须在该路由器的转发表中增加一个新的连接项；每当释放一个连接，必须从表中删除该项

在虚电路中有3个明显不同的阶段

* 虚电路建立    
  * 在建立阶段，运输层与网络层联系，指定接收方地址，等待网络建立虚电路。
  * 网络层决定发送方与接收方之间的路径，也为沿着该路径的每条链路决定一个VC号
  * 网络层在沿着路径的每台路由器的转发表中增加一个表项
* 数据传送
* 虚电路拆除    网络层通常将通知网络另一侧的端系统结束呼叫，并更新路径上每台分组路由器的转发表已表明该虚电路已经不存在

端系统向网络发送指示虚电路启动与终止的报文，以及路由器之间传递的用于建立虚电路的报文称为**信令报文**

### 4.2.2 数据报网络

在数据报网络中，每当一个端系统要发送分组，它就为该分组加上目的端系统的地址，然后将分组推进网络中。路由器不需要维护任何虚电路的信息状态。

每台路由器都使用分组的目的地址来决定出口链路接口（转发表）。转发表有**范围匹配**和**前缀匹配**，其中前缀匹配遵循最长前缀匹配原则


## 4.3 路由器工作原理
路由器的四个组成部分

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-22 220721.png" style="zoom:60%;" />

* 输入端口
  * 将一条输入的物理链路与路由器相连接
  * 与数据链路层交互的数据链路层功能
  * 查找功能
* 交换结构
  * 将输入端口与输出端口相连接
* 输出端口
  * 存储从交换结构接收的分组，并执行必要的链路层和物理层功能在输入链路上传输这些分组
* 路由选择处理器
  * 执行路由选择协议
  * 执行网路管理功能

### 4.3.1 输入端口

1. 查找：在每个输入端口存储有一份转发表的影子副本，转发决策就能在每个输入端口做出，无需调用中央路由选择处理器。一旦通过查找确定了某分组的输入端口，该分组就能够发送进入交换结构。
2. 物理层和链路层处理
3. 检验分组的版本号、检验和、寿命字段，并且重写后面两个字段
4. 更新用于网络管理的计数器



### 4.3.2 交换结构
交换结构位于一台路由器的核心部位，交换可以用许多方式完成

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-20 143653.png" style="zoom:60%;" />

* 经内存交换

  * 如果内存的宽带为每秒写入或读出B个分组，那么路由器的转发吞吐量小于B/2
  * 不能同时转发两个分组，因为经过共享系统总线一次只能执行一个内存读写

* 经总线交换

  输入端口经一根共享总线将分组直接传送带输出端口，不需要路由选择器的干预。交换机通过对分组打标签来指示对应的输出端口。需要注意的是每个分组必须跨越单一总线，所以除了一个分组外，其他分组必须等待。

* 经互联网络交换

  每条垂直的总线与每条水平的总线交叉，交叉点用过交换结构控制器能够在任何时候开启和闭合。纵横式网络可以同时并行转发多个分组，但是依旧需要保证同一条总线上只有一个分组在转发。

### 4.3.3 输出端口

输出端口处理存放在输出端口内存中的分组并将其发送到输出链路上

* 选择和取出排队的分组进行传输
* 执行所需的链路层和物理层传输功能

### 4.3.4 何时出现排队

交换结构的传输速率足够大时，就会出现输出端口的排队

输入端口的速率足够大时，就会出现HOL(线路前部阻塞)



## 4.4 网际协议：因特网中的转发和编址

### 4.4.1 数据表格式

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-20 150422.png" style="zoom:60%;" />

IPv4数据报中的关键字段如下

* 版本号 4bit
* 首部长度 4bit    确定IP数据报中数据部分实际从哪里开始
* 服务类型    以便使不同类型的IP数据报相互区别开来
* 数据报长度 16bit    IP数据报的总长度（以字节记）
* 标识、标志、片偏移
* 寿命（TTL）    确保数据报不会永远在网络中循环。每当数据报由一台路由器处理时，该字段的值减1。若TTL的值为0，则该数据报必须被丢弃
* 协议    该字段指示了IP数据报的数据部分应交给哪个特定的运输层协议
* 首部检验和    只对IP数据报的首部数据进行求和检验
* 源和目的IP地址
* 选项
* 数据（有效载荷）

注意到一个IP数据报有总长为20字节的首部（假设无选项）。如果数据报承载一个TCP数据报，则每个数据报共承载了总长40字节的首部以及应用层报文

<center><strong>IP数据报分片</strong></center>

一个链路层帧能承载的最大数据量叫做**最大传送单元（MTU）**，链路层的MTU限制了IP数据报的长度。解决问题的方案是将IP数据报中的数据分片成两个或更多个较小的IP数据报，用单独的链路层帧封装这些较小的IP数据报，然后向输出链路上发送这些帧。分片的重新组装工作放到端系统中，而不是在网络路由中。

当路由器需要对一个数据报分片时，形成的每个分片具有初始数据报的原地址、目的地址与标识号。最后一个分片的标志比特被设置为0，其他分片的标志比特为1。另外使用偏移字段可以确定每一个分片在原数据报中的位置。

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-22 231045.png" style="zoom:60%;" />



### 4.4.2 IPv4编址

每个IP地址长度为32比特，按照**点分十进制记法**书写，即地址中的每个字节用它的十进制形式书写，各个字节间以句点隔开。

全球因特网中的每台主机和路由器上的每个接口，必须有一个全球唯一的IP地址。

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 165421.png" style="zoom:60%;" />

**子网**：无路由器连接这些主机的网络称为子网，例如上图中左上的三台主机与联机它们的路由器接口，都有一个形如223.1.1.xxx的IP地址。

**子网掩码**：IP编址为这个子网分配一个地址：223.1.1.0/24，其中/24的记法，有时也称为子网掩码，指示了32比特中的最左侧24位定义了子网地址

因特网的地址分配策略称为**无类别域间路路由选择**（CIDR）。对于子网寻址，32比特的IP地址被划分为两部分，并且也具有点分十进制数形式a,b,c,d/x，其中/x指示了地址中第一部分的比特数。剩余部分可以认为是区分该组织内部设备的

#### 4.4.2.1 获取一块地址

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 171506.png)

#### 4.4.2.2 获取主机地址：动态主机配置协议DHCP

路由器接口的IP地址有管理员手动配置。主机地址通过**DHCP**完成配置。DHCP允许主机自动获取一个IP地址。管理员也可以配置DHCP，以使给定主机每次与网络连接时能得到一个相同的IP地址，或者被分配一个临时IP地址。

DHCP具有能将主机连接进一个网络的网络相关方面的自动能力，因此又常被称为**即插即用协议**。IP地址池、临时IP地址

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 182003.png" style="zoom:60%;" />

DHCP是一个**客户-服务器协议**。客户是新到达的主机，每个子网都将具有一台DCHP服务器。对于一台新到达的主机而言，DCHP协议是一个4个步骤的过程：

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 183055.png" style="zoom:60%;" />

* DCHP服务器发现：一台新到达的主机的首要任务是发现一个要与其交互的DHCP服务器。这可以通过使用一个**DHCP发现报文**来完成，客户在UDP分组中向端口67发送给发现报文。其中使用广播目的地址255.255.255.255，并且使用“本主机”源地址0.0.0.0。DHCP客户将该IP数据报传送给链路层，链路层然后将该帧广播到所有与该子网连接的子网。
* DHCP服务器提供：DHCP服务器收到一个DHCP发现报文时，用一个**DCHP提供报文**向客户做出回应，仍然使用IP广播地址255.255.255.255。
  * 服务器的报文内容有：发现报文的事务ID、向客户推荐的IP地址、网络掩码以及IP地址租用期
* DHCP请求：新到达的客户从一个或多个服务器提供中选择一个，并向选中的服务器提供一个**DHCP请求报文**作为响应
* DHCP ACK：服务器用DHCP ACK报文对DHCP请求报文进行响应

#### 4.4.2.3 网路地址转换NAT

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 183344.png)

从本质上讲，NAT使能路由器对外界隐藏了内部网络的细节。

**NAT转换表**：每当NAT路由器接收到内部网路对外部网络的报文请求时，就位该数据报新生成一个源端口号，并且将这个源端口号和内部网络的源端口号的对应关系记录在NAT转换表上。

#### 4.4.2.4 NAT穿越

NAT的一个重要问题是妨碍P2P应用程序。在一个P2P应用程序中，任何参与对等方A应该能够对任何其他参与对等方B发送一条TCP连接。如果对等方B在一个NAT后面，它就不能充当服务器并接收TCP连接

* UPnP：UPnP允许外部主机使用TCP或UDP向NAT化的主机发起通信会话。

  ![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 190025.png)

* 连接反转：A能够首先通过一个中间对等方C与对等方B联系，其中C不位于NAT之后并与B已经创建了一条进行中的TCP连接。A则能够经C请求B，发起直接返回A的一条TCP连接



### 4.4.3 因特网控制报文协议ICMP

ICMP被主机和路由器用来彼此沟通网络层的信息，最经典的用途是差错报告。ICMP报文有一个类型字段和一个编码字段，并且包含引起该IMCP报文首次生成的IP数据报的首部和前8字节的内容。

![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 192441.png)

Traceroute程序使用ICMP报文实现获知途径路由器名称和地址的功能。（TTL过期、目的端口不可达）



#### 4.4.4 IPv6

#### 4.4.4.1 IPv6数据报格式

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 193113.png" style="zoom:80%;" />

相比IPv4的改进

* 扩大的地址容量：
  * IPv6的IP地址长度增加到128比特。
  * 除了单播地址与多播地址以外，IPv6还引入了任播地址，这种地址可以将数据报交付给一组主机中的任意一个。
* 简化高效的40字节首部
* 流标签与优先组
* ICMPv6：根据IPv6的特性增加了新的类型和编码

IPv6定义的字段

* 版本 4bit
* 流量类型 8bit    类似于IPv4中的TOS字段
* 流标签 20bit   用于标识一条数据报的流
* 有效载荷长度 16bit
* 下一个首部    该字段标识数据报中的内容（数据字段）需要交付给哪个协议（如TCP或UDP）
* 跳限制    转发数据报的每台路由器将对该字段的内容减一。如果跳限制计数到达零时，该数据报将被丢弃
* 源地址和目的地址
* 数据

IPv4存在但是在IPv6中不存在的字段

* 分片/重新组装
* 首部检验和
* 选项

#### 4.4.4.2 从IPv4到IPv6的迁移

1. **双栈**：使用该方法的IPv6结点还具有完整的IPv4实现，具有接受和发送IPv4和IPv6两种数据报的能力。

   ![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 195300.png)

   然而在执行IPv6到IPv4的转换时，有一些IPv6数据报中特定的字段在IPv4中没有对应部分，这些字段的信息将会丢失。

2. **建隧道**：将两台IPv6路由器之间的中间IPv4路由器集合称为一个隧道。在隧道发送端的IPv6结点可将整个IPv6数据报放到一个IPv4数据报的有效载荷中。隧道接收端的IPv6结点最终收到该IPv4数据报，并确定该IPv4数据报含有一个IPv6数据报，于是从中提取出IPv6数据报，然后再为该IPv6数据报提供路由。

   ![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-23 195626.png)

### 4.4.5 IP安全性-IPsec

由IPsec会话提供的服务包括

* 密码技术约定    这种机制允许两台通信的主机对加密算法和密钥达成一致
* IP数据报有效载荷的加密
* 数据完整性    保证被加密的有效载荷没有被修改过
* 初始鉴别



## 4.5 路由选择算法

* 全局式&分布式
  * 全局式路由选择算法：用完整的、全局性的网络知识计算从源到目的地之间的最低费用路径。这种算法需要输入所有结点之间的连通性以及所有链路的费用。具有全局信息的算法常被称为**链路状态算法（LS算法）**
  * 分散式路由选择算法：以迭代、分布式的方式计算出最低费用路径，没有结点拥有关于所有网络链路费用的完整信息，每个结点仅有与其直接相连链路的费用知识就可以开始工作。
* 静态&动态
  * 静态路由选择算法：随着时间的流逝、路由的变化是非常缓慢的，通常是人工干预进行调整。
  * 动态路由选择算法：能够当网络流量负载或拓扑发生变化时改变路由选择路径。
* 负载敏感&负载迟钝
  * 负载敏感算法：链路费用会动态变化以反映出底层链路的当前拥塞水平
  * 负载迟钝算法：当今因特网的路由选择算法都是负载迟钝的



### 4.5.1 链路状态路由选择算法LS -Dijkstra算法

<a href="https://www.bilibili.com/video/BV1QK411V7V4">Dijkstra算法</a>计算从某结点到网络中所有其他节点的最低费用路径。

震荡：当链路的费用依赖于所承载的流量时，就会在运行LS算法之后出现震荡。

解决方案：

* 强制链路费用不依赖于所承载的流量（不可接受）
* 确保并非所有的路由器都同时运行LS算法（合理）

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-27 150955.png" style="zoom:60%;" />



### 4.5.2 距离向量路由算法 DV

使用DV算法，每个结点x维护下列路由选择信息：

* 对于每个邻居v，从x到直接相连邻居v的费用为c(x, v)
* 它的每个邻居的距离向量
* 结点x的距离向量，包含了x到N中所有目的地y的费用估计值

在该算法中，每个结点不时的向它的每个邻居发送它的距离向量副本。当结点x从它的任何一个邻居v接收到一个新距离向量，它保存v的距离向量，然后使用BF方程更新它自己的距离向量$$ D_x(y)=min\{c(x,v)+D_v(y)\} $$

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-27 214031.png" style="zoom:60%;" />

#### 4.5.2.1 距离向量算法：链路费用改变与链路故障

好消息（路径费用降低）传播速度快；坏消息（路径费用增加）传播速度慢

#### 4.5.2.2 距离向量算法：增加毒性逆转

上述特定循环的场景可以使用一种称为**毒性逆转**的技术加以避免。其思想为：如果z通过y路由选择到目的地x，则z将通告y，它到x的距离是无穷大，即$D_z(x)=∞$

#### 4.5.2.3 LS与DV路由器选择算法的比较

* 报文复杂性：LS算法需要每个结点都知道网络中每条链路的费用，这就要求发送$O(|N||E|)$个报文。而且任何一条链路的费用发生改变，必须向所有结点发送新的链路费用。对于DV算法，仅当新的链路费用导致与该链路相连结点的最低费用路径发生改变时，才传播已改变的链路费用
* 收敛速度：LS算法是时间复杂度为$O({|N|}^2)$的算法。DV算法收敛较慢，且会遭遇无穷计数的问题
* 健壮性：LS算法一定程度上路由计算时分离的；DV算法可能会将一个不正确结点计算值扩散到整个网络。



### 4.5.3 层次路由选择

在实践中，会遇到两个问题：网络规模、管理自治。这两个问题都可以通过将路由器组织进**自治系统(AS)**来解决。每一个AS由一组通常处在相同管理控制下的路由器组成。在相同的AS中的路由器都全部**运行相同的路由选择算法**，且拥有彼此的信息。在一个AS内运行的路由算法叫做**自治系统内部路由选择协议**。AS彼此互联也是必须的，因此在一个AS内的一台或多台路由器将有另外的任务，负责向本AS之外的目的地转发分组，这些路由器被称为**网关路由器**

![](F:\Study_Sources\2021autumn\计算机网络\images\Snipaste_2021-10-27_19-58-33.png)

当源AS具有两条或更多条链路（通过一台或更多台网关路由器）通向外部AS时，需要**自治系统间路由选择协议**来从相邻AS获取可达性信息和向该AS中所有路由器传播可达性信息。

**热土豆路由选择**

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-10-27 221537.png" style="zoom: 80%;" />



## 4.6 因特网中的路由选择

### 4.6.1 因特网中自治系统内部的路由选择：RIP

### 4.6.2 因特网中自治系统内部的路由选择：OSPF

### 4.6.3 自治系统间的路由选择：BGP



## 4.7 广播和多播路由选择

### 4.7.1 广播路由选择算法

#### 4.7.1.1 无控制洪泛

#### 4.7.1.2 受控洪泛

#### 4.7.1.3 生成树广播



### 4.7.2 多播

