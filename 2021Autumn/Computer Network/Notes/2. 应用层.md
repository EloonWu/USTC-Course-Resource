# 2. 应用层
## 2.1 应用层协议原理
研发网络应用程序的核心是写出**能够运行在不同端系统**和**通过网络彼此通信**的程序。不需要写在网络核心设备上运行的程序
### 2.1.1 网路应用程序体系结构
#### 2.1.1.1 客户-服务器结构
总是打开的主机称为服务器，它服务于来自许多其他称为客户的主机的请求
* 客户相互之间不直接通信
* 服务器具有固定的、周知的地址，称为IP地址
#### 2.1.1.2 P2P结构
应用程序在间断连接的主机之间使用直接通信，这些主机称为对等方。对等方通信不必通过专门的服务器
自扩展性：每个对等方通过向其他对等方提供服务来增加系统的服务能力

### 2.1.2 进程通信
在不同端系统上的进程，通过跨越计算机网络交换message来通信
#### 2.1.2.1 客户和服务器进程
发起通信的进程被标识为客户，等待联系的进程是服务器
#### 2.1.2.2 进程与计算机网络之间的接口
进程通过称为socket的软件接口向网络发送message或接收message
由于spcket是同一台主机内应用层与传输层之间的接口，因此socket也被称为应用程序与网络之间的API
#### 2.1.2.3 进程寻址
主机由其IP地址唯一标识

### 2.1.3 可供应用程序使用的运输服务
#### 2.1.3.1 可靠数据传输
一些app需要100%的可靠数据传输，一些app可以容忍数据丢失
#### 2.1.3.2 吞吐量
一些app对最低吞吐量有要求（带宽敏感应用），一些app可以或多或少的利用可供使用的吞吐量（弹性应用）
#### 2.1.3.3 定时
一些app要求时延要比较低
#### 2.1.3.4 安全性

### 2.1.4 互联网提供的运输服务
互联网为应用程序提供了两个运输层协议，即UDP和TCP

#### 2.1.4.1 TCP服务
* 面向连接的服务：在应用层数据message开始流动之前，TCP让客户和服务器相互交换运输层控制信息，在两个进程的socket之间建立TCP连接
* 可靠的数据传送服务
* 拥塞控制机制
* 使用SSL(Secure Socket Layer)来加强以提供安全服务
* 
#### 2.1.4.2 UDP服务
* 无连接：在两个进程通信前没有握手过程
* 不可靠数据传送服务
* 没有拥塞控制机制

### 2.1.5 应用层协议
应用层协议定义了：
* 交换的message类型，例如请求message和响应message
* 各种message类型的语法，如message中的各个字段以及这些字段是如何描述的
* 字段的语义，即这些字段中包含的信息的含义
* 一个进程何时以及如何发送message，对message进行相应的规则

## 2.2 Web和HTTP

### 2.2.1 HTTP概况
Web页面由许多objects组成，这些objects可以是HTML文件、图片等等，多数Web页面包含一个HTML基本文件以及几个引用对象。Web浏览器实现了HTTP客户，Web服务器实现了HTTP的服务器。

HTTP客户首先发起一个与服务器的TCP连接，一旦连接建立，浏览器和服务器进程就可以通过socket访问TCP。TCP为HTTP提供可靠数据传输服务。
![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 171444.png)
HTTP是一个无状态(stateless)协议：服务器不存储任何关于客户的状态信息

### 2.2.2 非持续连接与持续连接

#### 2.2.2.1 采用非持续连接的HTTP
对于每一个object都要经历1.客户请求建立TCP连接、2.服务器同意建立TCP连接、3.客户发送HTTP请求message、4.服务器发送HTTP相应message、5.断开TCP连接的过程
![](F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 172408.png)
往返时间RTT：一个packet从客户到服务器再返回客户所需的时间
**非持续连接的HTTP的响应时间=2RTT+文件传输时间**

#### 2.2.2.2 采用持续连接的HTTP
服务器再发送相应后保持该TCP连接打开，在相同的客户与服务器之间的后续请求和相应message能够通过相同的连接进行传送。
* 非流水线：建立TCP连接需要一个RTT，每个object的传输需要一个RTT
* 流水线：建立TCP连接需要一个RTT，可以在一个RTT中传输多个文件**（注意审题）**
<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 173532.png" style="zoom:80%;" />
<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 173629.png" style="zoom:67%;" />

### 2.2.3 HTTP message格式
#### 2.2.3.1 HTTP请求meaasge
HTTP请求message的第一行叫请求行(request line)，其后继行叫做首部行(header line)

<img src="F:\Study_Sources\2021autumn\计算机网络\images\图片1.png" style="zoom:50%;" />

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 184508.png" style="zoom:60%;" />

请求行有三个字段：方法字段、URL字段和HTTP版本字段
* 方法字段：GET、POST、HEAD、PUT和DELETE。绝大多数的请求message使用GET；当用户提交表单时使用POST；PUT允许用户上传对象到指定的Web服务器上指定的路径；DELETE允许用户或应用程序删除Web服务器上的对象。
* URL字段：带有请求对象的标识
* HTTP版本

首部行
* Host指明了对象所在的主机；
* User-agent指明了用户使用的浏览器类型
* Connection：keep-alive指明了浏览器要求服务器在发送请求后维持连接

#### 2.2.3.2 HTTP响应message
HTTP响应message有三个部分：1个初始状态行、6个首部行、实体体

<img src="F:\Study_Sources\2021autumn\计算机网络\images\图片2.png" style="zoom:48%;" />

状态行：协议版本字段、状态码、相应状态信息

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 185434.png" style="zoom:60%;" />

首部行：
* Connection：告诉客户发送完message后TCP连接的状态
* Date：服务器从它的文件系统中检索到object，插入到相应message并发送该message的时间
* Sever：显示发送message服务器的信息
* Last-Modified：指示了object创建或者最后修改的日期和时间
* Content-Length：指示了被发送object中的字节数
* Content-Type：指示了被发送的object的文件类型

### 2.2.4 用户与服务器的交互:cookie
cookie技术有4个组件：
1. 在HTTP相应message中的一个cookie首部行
2. 在HTTP请求message中的一个cookie首部行
3. 在用户端系统中保留有一个cookie文件，并由用户的浏览器进行管理
4. 位于Web站点的一个后端数据库

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 190222.png" style="zoom:60%;" />

### 2.2.5 Web缓存
Web缓存器有自己的磁盘存储空间，并在存储空间中保存最近请求过的object的副本

#### 2.2.5.1 Web缓存的过程
<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 190323.png" style="zoom:60%;" />

* 浏览器建立一个到Web缓存器的TCP连接，并向Web缓冲器中的object发送一个HTTP请求
* Web缓存器进行检查，看本地是否存储了相应object的副本。如果有，Web缓存器就向客户浏览器用HTTP响应message返回该object
* 如果没有，就打开一个与该object的初始服务器的TCP连接。通过HTTP请求和响应传输object
* 当Web缓存器接收到该object时，在本地存储空间存储一份副本，并向客户的浏览器发送该副本

值得注意的是，Web缓存器既是客户，又是服务器

#### 2.2.5.2 Web缓存的优点
* 大大减少对客户请求的响应时间
* 大大减少一个机构的接入链路到互联网的通信量

### 2.2.6 条件GET
#### 2.2.6.1 条件GET介绍
解决Web缓存器中的副本可能陈旧的问题
如果请求message使用GET，并且请求message中包含一个“If-Modified-Since”的首部行，那么就是一个条件GETmessage

#### 2.2.6.2 条件GET操作方式

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 192006.png" style="zoom:60%;" />

## 2.3 文件传输协议：FTP
### 2.3.1 FTP概述
FTP运行在TCP上，使用两个并行的TCP来传输文件，一个是控制连接，一个是数据连接。
* 控制连接用于在两主机之间传输控制信息
* 数据连接用于实际发送一个文件
 <img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 193306.png" style="zoom:60%;" />
  对于FTP而言，控制连接贯穿了整个用户对话期间，但是对会话中的每一次文件传输都需要建立一个新的数据连接

FTP服务器必须在整个会话期间保留用户的状态，特别是需要将特定的用户和控制连接联系起来

### 2.3.2 FTP命令与回答
从客户到服务器的命令和从服务器到客户的回答都是以7比特ASCII格式在控制连接上传送的
常见命令如下：

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 193922.png" style="zoom:60%;" />

回答是一个三位数字：

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-15 194044.png" style="zoom:60%;" />

## 2.4 互联网中的电子邮件
电子邮件是一种异步通信媒介，有3个主要组成部分：用户代理、邮件服务器、简单邮件传输协议（SMTP）。

一个典型的邮件发送过程是：从发送方的用户代理开始，传输到发送方的邮件服务器，再传输到接收方的邮件服务器，然后在这里被分发到接收方发邮箱中。

### 2.4.1 SMTP
#### 2.4.1.1 SMTP概述
* SMTP使用TCP可靠数据传输服务
* SMTP基本不使用中间邮件服务器发送邮件
* 限制所有邮件的Body部分只能使用7bit ASCII形式
#### 2.4.1.2 SMTP传输过程
1. 客户在25号端口建立一个到服务器SMTP的TCP连接
2. 服务器与客户握手，客户指示发送方的邮件地址和接收方的邮件地址
3. 客户发送message。该客户如果有另外的message要发送到该服务器，就在相同的TCP连接上重复这种处理；否则，就指示TCP关闭连接

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-18 185033.png" style="zoom:67%;" />
以C：开头的文本行是客户发送给服务器的行，以S：开头的文本行是服务器发送给客户的行

### 2.4.2 与HTTP的对比
1. HTTP是一个pull协议：某些人在Web服务器上装在信息，用户使用HTTP从该服务拉取这些信息，特别是TCP连接是由想接收文件的机器发起的；
SMTP是一个Push协议：即发送邮件服务器把文件推向接收邮件服务器，特别是这个TCP连接是由要发送该文件的机器发起的；
2. SMTP要求每个message使用7bitASCII格式；
HTTP数据则不受这种限制
3. 当在处理既包含文本又包含图形的文档时，HTTP把每一个对象封装到自己的HTTP相应message中；SMTP则把所有message对象放在一个message中

### 2.4.3 邮件message格式与MIME
首部行和message的body用空行进行分隔
* 首部行包含环境信息（接收方地址、发送方地址、日期等）。首部行有精确格式，包含了可读的文本，由关键词后跟冒号及其值组成。每个首部行包含一个From：和To：
* Body包含了电子邮件的内容

### 2.4.4 邮件访问协议

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-18 191906.png" style="zoom:60%;" />

#### 2.4.4.1 POP3
当客户打开一个到邮件服务器的TCP连接后，POP3就开始工作了。随着TCP的建立，POP3按照三个阶段进行工作：特许、事物处理核更新；
1. 特许：用户代理发送用户名和口令以鉴别用户
2. 事物处理（下载并删除或下载并保留）：用户代理取回message，同时还可以对message做删除标记以及获取message的统计信息
3. 更新：在用户发送quit的命令之后，结束POP3会话，邮件服务器删除被标记为删除的message
#### 2.4.4.2 IMAP
* IMAP服务器将每一个Message和一个文件夹联系起来
* IMAP为用户提供了创建文件夹以及将邮件从一个文件夹移动到另一个文件夹的命令；
* IMAP维护了IMAP会话的用户状态信息（文件夹的名字、哪些message与哪些文件夹相关联）
#### 2.4.4.3 基于Web的电子邮件
使用HTTP接收电子邮件



## 2.5 DNS：因特网的目录服务
### 2.5.1 DNS提供的服务
DNS是一种能进行主机名到IP地址转换的目录服务
* DNS是一个由分层的DNS服务器实现的分布式数据库
* DNS是一个使得主机能够查询分布式数据库的应用层协议

除了进行主机名到IP地址的转换外，DNS还提供了一些重要的服务
* 主机别名：可以调用DNS来获得主机别名对应的规范主机名以及主机的IP地址
* 邮件服务器别名：
* 负载分配：用于在冗余的服务器之间进行负载分配

### 2.5.2 DNS工作机理概述
集中式设计的缺陷：
* 单点故障
* 通信容量
* 远距离的集中式数据库
* 维护

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-18 195821.png" style="zoom:60%;" />

#### 2.5.2.1 分布式、层次数据库
有3种类型的DNS服务器：根服务器、顶级域DNS服务器、权威服务器
* 根服务器：世界范围内有13台
* 顶级域服务器：这些服务器负责顶级域名
* 权威DNS服务器
* 本地DNS服务器

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-19 173732.png" style="zoom: 67%;" />

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-19 174418.png" style="zoom:67%;" />

递归查询：域名服务器将代替提出请求的客户机（下级DNS服务器）进行域名查询，若域名服务器不能直接回答，则域名服务器会在域各树中的各分支的上下进行递归查询，最终将返回查询结果给客户机，在域名服务器查询期间，客户机将完全处于等待状态。
迭代查询：当服务器使用迭代查询时能使其他服务器返回一个最佳的查询点提示或主机地址，若此最佳的查询点中包含需要查询的主机地址，则返回主机地址信息，若此时服务器不能够直接查询到主机地址，则是按照提示的指引依次查询，直到服务器给出的提示中包含所需要查询的主机地址为止

#### 2.5.2.2 DNS缓存
当某DNS服务器接收一个DNS回答时，将该回答的信息缓存在本地存储器中。由于主机名与IP地址之间的映射不是永久的，DNS服务器在一段时间后将丢弃缓存的信息

### 2.5.3 DNS记录和message
DNS分布式数据库的所有DNS服务器存储了资源记录RR(Resource Record)。其中提供了主机名到IP地址的映射。
资源记录是一个包含了下列字段的4元组：（Name，Value，Type，TTL）
* TTL是该记录的生存时间，决定了资源记录应当从缓存中删除的时间
* **Type=A**：Name是主机名，Value是主机名对应的IP地址
* **Type=NS**：Name是域（foo.com），Value是知道如何获得该域中主机IP地址的权威DNS服务器的主机名（dns.foo.com）。
* Type=CNAME：Value是别名为Name的主机对应的规范主机名。该记录能向查询的主机提供一个主机名对应的规范主机名。
* Type=MX：Value是别名为Name的邮件服务器的规范主机名。

#### 2.5.3.1 DNS message

<img src="F:\Study_Sources\2021autumn\计算机网络\images\屏幕截图 2021-09-19 180122.png" style="zoom:60%;" />

* 标识符：用于标识该查询，以便让客户用它来匹配发送的请求和接收到的回答
* 标志：1bit的"查询/回答"标志位指出是查询message(0)还是回答message(1)；当某DNS服务器是所请求名字的权威DNS服务器时，1bit的“权威”标志位被置于回答message中；如果客户在该DNS服务器没有某记录时希望执行递归查询，将设置1bit的“希望递归”标志位；如果该DNS服务器支持递归查询，则在回答message中置有1bit的“递归可用”标志位
* 问题区域：1. 名字字段，指出正在被查询的主机的名字；2. 类型字段：指出有关该名字的正被查询的问题类型；
* 回答区域：包含对最初请求的名字的资源记录
* 权威区域：包含了其他权威服务器的记录；
* 附加区域：包含了其他有帮助的记录；

#### 2.5.3.2 在DNS数据库中插入记录
1. 向注册登记机构提供基本和辅助权威DNS服务器的名字和IP地址
2. 注册登记机构将两条资源记录插入该DNS系统中
(networkutopia.com, dns1.networkutopia.com, NS)
(dns1.networkutopia.com, 212.212.212.1, A)

观看www.networkutopia.com 的Web页面将经历如下步骤：
* 主机箱本地DNS服务器发送请求
* 该本地服务器联系一个TLD com服务器（如果TLD com服务器的地址没有被缓存，该本地DNS服务器也将必须与根DNS服务器相联系）
* TLD com服务器相本地服务器发送一个回答，包括两条资源记录。
* 本地DNS服务器向212.212.212.1发送一个DNS查询，请求对应于www.networkutopia.com 的类型A记录，并将返回的记录发送给主机
* 主机向对应的IP地址发起一个TCP连接，并在该连接上发送一个HTTP请求

## 2.6 P2P应用
### 2.6.1 P2P文件分发
#### 2.6.1.1 P2P体系结构的扩展性
对于传统的客户-服务器体系结构，分发文件所需的时间受制于客户的数量N、服务器的上传速率$u_s$、传输文件的大小F、客户端最小的下载速率$d_{min}$
$$ D_{cs}=max\left\{\frac{NF}{u_s},\frac{F}{d_{min}}\right\} $$

在P2P体系结构中，当一个对等方接受到某数据文件时，它能够使用自己的上载能力重新将数据分发给其他对等方
* 在分发的开始，只有服务器具有该文件。该服务器必须经其接入链路至少发送该文件的每个比特一次。因此最小分发时间为$\frac{F}{u_s}$
* 具有最低下载速率的对等方不能够以小于$\frac{F}{d_{min}}$的分发时间获得所有F比特
* 系统的总上载能力等于服务器的上载速率加上每个对等方的上载速率。系统必须向这N个对等方的每个交付F比特，因此总共交付FN比特。因此最小分发时间为$\frac{NF}{u_s+u_1+....+u_N}$
因此P2P的最小分发时间为
$D_{P2P}=max\left\{\frac{F}{u_s},\frac{F}{d_{min}},\frac{NF}{u_s+u_1+....+u_N}\right\}$

#### 2.6.1.2 BitTorrent
参与一个特定文件分发放的所有对等方的集合称为一个torrent，在一个torrent中的对等方彼此下载等长度的文件块。
每个torrent有个基础设施结点，称为tracker，当一个对等方加入torrent时，它向tracker注册自己，并周期性的通知tracker它仍在torrent中
* 当一个新的对等方加入torrent时，tracker随机的从参与对等方的集合中选择对等方的一个子集，并将IP地址发送给它。新的对等方与列表上的所有对等方创建并行TCP连接。称所有这样TCP连接的对等方为”邻近对等方“
* 在任何时刻，用户将具有块的子集并知道他的邻居具有哪些块。使用最稀缺优先算法（最稀缺的块就是邻居中副本数量最少的块，这样可以均衡各个块在torrent中副本的数量）决定请求哪些块。
* tit-for-tat：Alice对于她的每个邻居都持续的测量接收到比特的速率，并确定以最高速率流入的4个邻居，每过30秒，Alice将随机的选择一位新的交换伴侣并开始与那位伴侣进行交换。如果这两名的地方都满足彼此对换，他们将彼此放入自己前4位的列表并继续与对方进行对换，直到一方找到更好的伴侣。

## 2.7 视频流和内容分发网络
### 2.7.1 DASH(Dynamic, Adaptive Streaming over HTTP)
* 服务器：将视频文件分为若干块，各个块按照不同的码率编码
* 客户：定期测量服务器到客户端的带宽，并依据当前的带宽请求最大码率的块。根据不同的带宽用户可以请求不同码率的视频块。

### 2.7.2 内容分发网络CDN
在每个CDN结点存储有内容副本，客户向CDN请求内容

## 2.8 TCP socket编程
### 2.8.1 UDP socket编程

### 2.8.2 TCP socket编程
